using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class KamishibaiController : MonoBehaviour
{
    // Unityエディタから画像を割り当てるための配列
    [SerializeField] private Sprite[] kamishibaiImages;

    // UIのImageコンポーネント
    private Image displayImage;

    // 現在表示中の画像のインデックス
    private int currentImageIndex = 0;

    // プレイヤーの得点
    private int score = 0;

    // 各画像で得点が入ったかを判定するフラグ
    private bool hasScoredOnCurrentImage = false;

    [SerializeField] private AudioClip switchSound; // 効果音をInspectorでセット
    [SerializeField] private AudioClip buttonSound; // ボタン用効果音をInspectorでセット
    private AudioSource audioSource; // AudioSource参照

    private void Start()
    {
        // Imageコンポーネントを取得
        displayImage = GetComponent<Image>();
        audioSource = GetComponent<AudioSource>(); // AudioSource取得

        // Coroutineを開始して、画像の切り替え処理を始める
        StartCoroutine(PlayKamishibai());
    }

    // ボタンクリック時に呼ばれるメソッド
    public void OnScoreButtonClick()
    {
        // ボタン効果音を再生
        if (buttonSound != null && audioSource != null)
        {
            audioSource.PlayOneShot(buttonSound);
        }
        // まだこの画像で得点が変わっていない場合のみ処理
        if (!hasScoredOnCurrentImage)
        {
            if (currentImageIndex == 1 || currentImageIndex == 3)
            {
                // 加点
                score += 100; // 例として100点加算
                Debug.Log("得点！現在のスコア: " + score);
            }
            else
            {
                // 減点
                score -= 100; // 例として100点減点
                Debug.Log("お手付き！現在のスコア: " + score);
            }
            hasScoredOnCurrentImage = true; // この画像ではもう得点・減点できないようにフラグを立てる
        }
    }

    private IEnumerator PlayKamishibai()
    {
        // 登録されている画像が20枚であることを確認
        if (kamishibaiImages.Length != 20)
        {
            Debug.LogError("画像は20枚登録してください。");
            yield break;
        }

        // 20枚の画像を順番に表示
        while (currentImageIndex < kamishibaiImages.Length)
        {
            // 現在のインデックスの画像を表示
            displayImage.sprite = kamishibaiImages[currentImageIndex];

            // 1つの画像が表示されるたびに、得点フラグをリセットする
            hasScoredOnCurrentImage = false;

            // 効果音を再生
            if (switchSound != null && audioSource != null)
            {
                audioSource.PlayOneShot(switchSound);
            }

            // 1秒待つ
            yield return new WaitForSeconds(1.0f);

            // 次の画像へ
            currentImageIndex++;
        }

        Debug.Log("紙芝居が終了しました。最終スコア: " + score);
    }
}